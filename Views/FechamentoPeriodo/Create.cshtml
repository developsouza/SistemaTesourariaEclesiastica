@model SistemaTesourariaEclesiastica.ViewModels.FechamentoUnificadoViewModel

@{
    ViewData["Title"] = Model.EhSede ? "Fechamento da SEDE" : "Fechamento de Período";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1 class="h3 mb-0">
                <i class="bi bi-@(Model.EhSede ? " building" : "calendar-check") me-2 text-primary"></i>
                @(Model.EhSede ? "Fechamento de Período - SEDE" : "Fechamento de Período")
            </h1>
            <p class="text-muted mb-0">
                @if (Model.EhSede)
                {
                    <text>Prestação de contas consolidada da SEDE</text>
                }
                else
                {
                    <text>Prestação de contas de @Model.NomeCentroCusto</text>
                }
            </p>
        </div>
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-2"></i>Voltar
        </a>
    </div>

    <!-- Validation Summary -->
    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <!-- Alert Informativo -->
    @if (Model.EhSede)
    {
        <div class="alert alert-info mb-4">
            <h5 class="alert-heading">
                <i class="bi bi-info-circle me-2"></i>Como funciona o Fechamento da SEDE?
            </h5>
            <hr>
            <ol class="mb-0 small">
                <li>Selecione o período do fechamento da SEDE</li>
                <li>O sistema mostrará as prestações das congregações <strong>aprovadas e pendentes de processamento</strong></li>
                <li>Selecione quais prestações deseja incluir neste fechamento</li>
                <li>Os valores das congregações serão <strong>somados</strong> aos valores da SEDE</li>
                <li>O <strong>rateio será aplicado sobre o total consolidado</strong></li>
                <li>As prestações incluídas serão <strong>marcadas como processadas</strong></li>
            </ol>
        </div>
    }
    else
    {
        <div class="alert alert-info mb-4">
            <h5 class="alert-heading">
                <i class="bi bi-info-circle me-2"></i>Informações sobre o Fechamento
            </h5>
            <hr>
            <p class="mb-1 small">
                O sistema calculará automaticamente:
            </p>
            <ul class="small mb-0">
                <li><strong>Balanço Físico:</strong> Dinheiro em espécie que deve ser repassado à Sede</li>
                <li><strong>Balanço Digital:</strong> Valores já depositados (PIX, transferências) - apenas informativo</li>
                <li>Após aprovação, este fechamento estará disponível para ser incluído no fechamento da SEDE</li>
            </ul>
        </div>
    }

    <form asp-action="Create" method="post">
        <input type="hidden" asp-for="CentroCustoId" />
        <input type="hidden" asp-for="NomeCentroCusto" />
        <input type="hidden" asp-for="EhSede" />
        <input type="hidden" asp-for="DataInicio" id="DataInicio" />
        <input type="hidden" asp-for="DataFim" id="DataFim" />

        <div class="row g-4">
            <!-- Coluna Esquerda - Dados do Fechamento -->
            <div class="@(Model.EhSede && Model.FechamentosDisponiveis.Any() ? " col-lg-5" : "col-lg-12")">
                <div class="card shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-check me-2"></i>
                            Dados do Fechamento
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Tipo de Fechamento -->
                        <div class="mb-3">
                            <label asp-for="TipoFechamento" class="form-label fw-semibold">Tipo de Fechamento</label>
                            <select asp-for="TipoFechamento" class="form-select" id="tipoFechamento">
                                <option value="@((int)SistemaTesourariaEclesiastica.Enums.TipoFechamento.Diario)" selected>Diário</option>
                                <option value="@((int)SistemaTesourariaEclesiastica.Enums.TipoFechamento.Semanal)">Semanal</option>
                                <option value="@((int)SistemaTesourariaEclesiastica.Enums.TipoFechamento.Mensal)">Mensal</option>
                            </select>
                            <span asp-validation-for="TipoFechamento" class="text-danger"></span>
                        </div>

                        <!-- Fechamento Diário -->
                        <div id="camposDiario" style="display: none;">
                            <div class="mb-3">
                                <label asp-for="DataInicio" class="form-label fw-semibold">Data do Fechamento</label>
                                <input asp-for="DataInicio" type="date" class="form-control" id="dataFechamentoDiario" />
                                <span asp-validation-for="DataInicio" class="text-danger"></span>
                            </div>
                        </div>

                        <!-- Fechamento Semanal -->
                        <div id="camposSemanal" style="display: none;">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label asp-for="DataInicio" class="form-label fw-semibold"></label>
                                    <input asp-for="DataInicio" type="date" class="form-control" id="dataInicioSemanal" />
                                    <span asp-validation-for="DataInicio" class="text-danger"></span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label asp-for="DataFim" class="form-label fw-semibold"></label>
                                    <input asp-for="DataFim" type="date" class="form-control" id="dataFimSemanal" />
                                    <span asp-validation-for="DataFim" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Fechamento Mensal -->
                        <div id="camposMensal">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label asp-for="Ano" class="form-label fw-semibold"></label>
                                    <select asp-for="Ano" class="form-select" id="selectAno"></select>
                                    <span asp-validation-for="Ano" class="text-danger"></span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label asp-for="Mes" class="form-label fw-semibold"></label>
                                    <select asp-for="Mes" class="form-select" id="selectMes">
                                        <option value="1">Janeiro</option>
                                        <option value="2">Fevereiro</option>
                                        <option value="3">Março</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Maio</option>
                                        <option value="6">Junho</option>
                                        <option value="7">Julho</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Setembro</option>
                                        <option value="10">Outubro</option>
                                        <option value="11">Novembro</option>
                                        <option value="12">Dezembro</option>
                                    </select>
                                    <span asp-validation-for="Mes" class="text-danger"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Observações -->
                        <div class="mb-3">
                            <label asp-for="Observacoes" class="form-label fw-semibold"></label>
                            <textarea asp-for="Observacoes" class="form-control" rows="3"></textarea>
                            <span asp-validation-for="Observacoes" class="text-danger"></span>
                        </div>

                        <div class="alert alert-secondary small mb-0">
                            <i class="bi bi-building me-1"></i>
                            <strong>Centro de Custo:</strong> @Model.NomeCentroCusto
                        </div>
                    </div>
                </div>

                <!-- Botão de Submissão -->
                <div class="d-grid gap-2 mt-3">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-check-circle me-2"></i>Criar Fechamento
                    </button>
                    <a asp-action="Index" class="btn btn-outline-secondary">
                        <i class="bi bi-x-circle me-2"></i>Cancelar
                    </a>
                </div>
            </div>

            <!-- Coluna Direita - Prestações das Congregações (apenas para SEDE) -->
            @if (Model.EhSede && Model.FechamentosDisponiveis.Any())
            {
                <div class="col-lg-7">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-list-check me-2"></i>
                                Prestações de Congregações Disponíveis
                            </h5>
                            <button type="button" class="btn btn-sm btn-light" id="toggleSelectAll">
                                <i class="bi bi-check-square me-1"></i>
                                <span id="toggleSelectAllText">Selecionar Todos</span>
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-success small mb-3">
                                <i class="bi bi-check-circle me-1"></i>
                                <strong>@Model.FechamentosDisponiveis.Count</strong> prestação(ões) aprovada(s) e disponível(is) para processamento.
                            </div>

                            <div class="accordion" id="accordionPrestacoes">
                                @for (int i = 0; i < Model.FechamentosDisponiveis.Count; i++)
                                {
                                    var item = Model.FechamentosDisponiveis[i];
                                    var accordionId = $"collapse{i}";
                                    var headingId = $"heading{i}";

                                    <div class="accordion-item mb-2">
                                        <h2 class="accordion-header" id="@headingId">
                                            <button class="accordion-button collapsed" type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#@accordionId"
                                                    aria-expanded="false"
                                                    aria-controls="@accordionId">
                                                <div class="w-100 d-flex justify-content-between align-items-center pe-3">
                                                    <div class="d-flex align-items-center">
                                                        <input type="checkbox"
                                                               name="FechamentosIncluidos"
                                                               value="@item.Id"
                                                               class="form-check-input fechamento-checkbox me-3"
                                                               checked="@item.Selecionado"
                                                               onclick="event.stopPropagation();" />
                                                        <div>
                                                            <strong>@item.NomeCongregacao</strong>
                                                            <br>
                                                            <small class="text-muted">
                                                                @item.DataInicio.ToString("dd/MM/yyyy") - @item.DataFim.ToString("dd/MM/yyyy")
                                                                | Aprovado em: @item.DataAprovacao.ToString("dd/MM/yyyy")
                                                            </small>
                                                        </div>
                                                    </div>
                                                    <div class="text-end">
                                                        <div>
                                                            <span class="badge bg-success">Entradas: @item.TotalEntradas.ToString("C")</span>
                                                            <span class="badge bg-danger">Saídas: @item.TotalSaidas.ToString("C")</span>
                                                        </div>
                                                        <div class="mt-1">
                                                            <span class="badge bg-warning text-dark">Balanço Físico: @item.BalancoFisico.ToString("C")</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </button>
                                        </h2>
                                        <div id="@accordionId" class="accordion-collapse collapse"
                                             aria-labelledby="@headingId"
                                             data-bs-parent="#accordionPrestacoes">
                                            <div class="accordion-body">
                                                <!-- Detalhes de Entradas -->
                                                @if (item.DetalhesEntradas.Any())
                                                {
                                                    <div class="mb-3">
                                                        <h6 class="text-success fw-bold mb-2">
                                                            <i class="bi bi-arrow-down-circle me-1"></i>
                                                            Entradas (@item.DetalhesEntradas.Count)
                                                        </h6>
                                                        <div class="table-responsive">
                                                            <table class="table table-sm table-hover">
                                                                <thead class="table-light">
                                                                    <tr>
                                                                        <th>Data</th>
                                                                        <th>Descrição</th>
                                                                        <th>Fonte</th>
                                                                        <th>Meio Pgto</th>
                                                                        <th class="text-end">Valor</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    @foreach (var detalhe in item.DetalhesEntradas)
                                                                    {
                                                                        <tr>
                                                                            <td class="small">@detalhe.Data.ToString("dd/MM/yy")</td>
                                                                            <td class="small">
                                                                                <strong>@detalhe.Descricao</strong>
                                                                                @if (!string.IsNullOrEmpty(detalhe.MembroOuFornecedor))
                                                                                {
                                                                                    <br>
                                                                
                                                                                    <small class="text-muted">@detalhe.MembroOuFornecedor</small>
                                                                                }
                                                                            </td>
                                                                            <td class="small">
                                                                                <span class="badge bg-success bg-opacity-10 text-success">
                                                                                    @detalhe.PlanoContas
                                                                                </span>
                                                                            </td>
                                                                            <td class="small text-muted">@detalhe.MeioPagamento</td>
                                                                            <td class="text-end small">
                                                                                <strong class="text-success">@detalhe.Valor.ToString("C")</strong>
                                                                            </td>
                                                                        </tr>
                                                                    }
                                                                </tbody>
                                                                <tfoot class="table-light">
                                                                    <tr>
                                                                        <td colspan="4" class="text-end fw-bold">Total:</td>
                                                                        <td class="text-end fw-bold text-success">
                                                                            @item.DetalhesEntradas.Sum(d => d.Valor).ToString("C")
                                                                        </td>
                                                                    </tr>
                                                                </tfoot>
                                                            </table>
                                                        </div>
                                                    </div>
                                                }

                                                <!-- Detalhes de Saídas -->
                                                @if (item.DetalhesSaidas.Any())
                                                {
                                                    <div>
                                                        <h6 class="text-danger fw-bold mb-2">
                                                            <i class="bi bi-arrow-up-circle me-1"></i>
                                                            Saídas (@item.DetalhesSaidas.Count)
                                                        </h6>
                                                        <div class="table-responsive">
                                                            <table class="table table-sm table-hover">
                                                                <thead class="table-light">
                                                                    <tr>
                                                                        <th>Data</th>
                                                                        <th>Descrição</th>
                                                                        <th>Categoria</th>
                                                                        <th>Meio Pgto</th>
                                                                        <th class="text-end">Valor</th>
                                                                    </tr>
                                                                </thead>
                                                                <tbody>
                                                                    @foreach (var detalhe in item.DetalhesSaidas)
                                                                    {
                                                                        <tr>
                                                                            <td class="small">@detalhe.Data.ToString("dd/MM/yy")</td>
                                                                            <td class="small">
                                                                                <strong>@detalhe.Descricao</strong>
                                                                                @if (!string.IsNullOrEmpty(detalhe.MembroOuFornecedor))
                                                                                {
                                                                                    <br>
                                                                
                                                                                    <small class="text-muted">@detalhe.MembroOuFornecedor</small>
                                                                                }
                                                                            </td>
                                                                            <td class="small">
                                                                                <span class="badge bg-danger bg-opacity-10 text-danger">
                                                                                    @detalhe.PlanoContas
                                                                                </span>
                                                                            </td>
                                                                            <td class="small text-muted">@detalhe.MeioPagamento</td>
                                                                            <td class="text-end small">
                                                                                <strong class="text-danger">@detalhe.Valor.ToString("C")</strong>
                                                                            </td>
                                                                        </tr>
                                                                    }
                                                                </tbody>
                                                                <tfoot class="table-light">
                                                                    <tr>
                                                                        <td colspan="4" class="text-end fw-bold">Total:</td>
                                                                        <td class="text-end fw-bold text-danger">
                                                                            @item.DetalhesSaidas.Sum(d => d.Valor).ToString("C")
                                                                        </td>
                                                                    </tr>
                                                                </tfoot>
                                                            </table>
                                                        </div>
                                                    </div>
                                                }

                                                @if (!item.DetalhesEntradas.Any() && !item.DetalhesSaidas.Any())
                                                {
                                                    <div class="alert alert-info small mb-0">
                                                        <i class="bi bi-info-circle me-1"></i>
                                                        Nenhum detalhe disponível para esta prestação.
                                                    </div>
                                                }

                                                <!-- Resumo do Balanço -->
                                                <div class="mt-3 p-3 bg-light rounded">
                                                    <div class="row text-center">
                                                        <div class="col-6">
                                                            <small class="text-muted d-block">Balanço Físico</small>
                                                            <strong class="text-warning">@item.BalancoFisico.ToString("C")</strong>
                                                        </div>
                                                        <div class="col-6">
                                                            <small class="text-muted d-block">Balanço Digital</small>
                                                            <strong class="text-info">@item.BalancoDigital.ToString("C")</strong>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                }
                            </div>

                            <!-- Resumo Geral -->
                            <div class="mt-3 p-3 bg-light rounded">
                                <div class="row text-center">
                                    <div class="col-4">
                                        <small class="text-muted d-block mb-1">Total Entradas</small>
                                        <strong class="text-success fs-5">@Model.FechamentosDisponiveis.Sum(f => f.TotalEntradas).ToString("C")</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block mb-1">Total Saídas</small>
                                        <strong class="text-danger fs-5">@Model.FechamentosDisponiveis.Sum(f => f.TotalSaidas).ToString("C")</strong>
                                    </div>
                                    <div class="col-4">
                                        <small class="text-muted d-block mb-1">Balanço Físico Total</small>
                                        <strong class="text-warning fs-5">@Model.FechamentosDisponiveis.Sum(f => f.BalancoFisico).ToString("C")</strong>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else if (Model.EhSede && !Model.FechamentosDisponiveis.Any())
            {
                <div class="col-lg-7">
                    <div class="alert alert-warning">
                        <h5 class="alert-heading">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Nenhuma Prestação Disponível
                        </h5>
                        <hr>
                        <p class="mb-0">
                            Não há prestações de congregações aprovadas e pendentes de processamento no momento.
                            O fechamento da SEDE será criado apenas com os lançamentos diretos da SEDE.
                        </p>
                    </div>
                </div>
            }
        </div>
    </form>
</div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        $(document).ready(function() {
            // Popular anos
            var anoAtual = new Date().getFullYear();
            for (var i = anoAtual + 1; i >= anoAtual - 5; i--) {
                $('#selectAno').append($('<option>', {
                    value: i,
                    text: i,
                    selected: i === anoAtual
                }));
            }

            // Definir mês atual
            var mesAtual = new Date().getMonth() + 1;
            $('#selectMes').val(mesAtual);

            // Definir data atual
            var hoje = new Date().toISOString().split('T')[0];
            $('#dataFechamentoDiario').val(hoje);

            // Função para atualizar DataInicio e DataFim baseado em Ano e Mês
            function atualizarDatasMensal() {
                var ano = parseInt($('#selectAno').val());
                var mes = parseInt($('#selectMes').val());

                if (ano && mes) {
                    // Primeiro dia do mês
                    var dataInicio = new Date(ano, mes - 1, 1);
                    // Último dia do mês
                    var dataFim = new Date(ano, mes, 0);

                    // Formatar para YYYY-MM-DD
                    var dataInicioFormatada = dataInicio.toISOString().split('T')[0];
                    var dataFimFormatada = dataFim.toISOString().split('T')[0];

                    // Atualizar campos hidden ou criar se não existirem
                    $('#DataInicio').val(dataInicioFormatada);
                    $('#DataFim').val(dataFimFormatada);

                    console.log('Fechamento Mensal - DataInicio:', dataInicioFormatada, 'DataFim:', dataFimFormatada);
                }
            }

            // Atualizar datas quando ano ou mês mudarem
            $('#selectAno, #selectMes').change(function() {
                atualizarDatasMensal();
            });

            // Inicializar com o tipo Diário selecionado
            $('#camposDiario').show();
            $('#camposSemanal, #camposMensal').hide();
            
            // Inicializar DataInicio e DataFim com a data de hoje para fechamento diário
            var dataDiario = $('#dataFechamentoDiario').val();
            $('#DataInicio').val(dataDiario);
            $('#DataFim').val(dataDiario);

            // Alternar entre Diário, Semanal e Mensal
            $('#tipoFechamento').change(function() {
                var tipo = $(this).val();

                $('#camposDiario, #camposSemanal, #camposMensal').hide();

                if (tipo == '1') { // Diário
                    $('#camposDiario').show();
                    // Copiar data do diário para DataInicio e DataFim
                    var dataDiario = $('#dataFechamentoDiario').val();
                    $('#DataInicio').val(dataDiario);
                    $('#DataFim').val(dataDiario);
                } else if (tipo == '2') { // Semanal
                    $('#camposSemanal').show();
                    // Para semanal, os próprios campos já são DataInicio e DataFim
                } else { // Mensal
                    $('#camposMensal').show();
                    atualizarDatasMensal();
                }
            });

            // Quando data diária mudar
            $('#dataFechamentoDiario').change(function() {
                var dataDiario = $(this).val();
                $('#DataInicio').val(dataDiario);
                $('#DataFim').val(dataDiario);
            });

            // ✅ NOVO: Botão Selecionar Todos / Desmarcar Todos
            var todosCheckboxes = $('.fechamento-checkbox');
            var allSelected = todosCheckboxes.length > 0 && todosCheckboxes.filter(':checked').length === todosCheckboxes.length;

            // Atualizar texto inicial do botão
            if (allSelected) {
                $('#toggleSelectAllText').text('Desmarcar Todos');
                $('#toggleSelectAll i').removeClass('bi-check-square').addClass('bi-square');
            }

            $('#toggleSelectAll').click(function() {
                var checkboxes = $('.fechamento-checkbox');
                var allChecked = checkboxes.filter(':checked').length === checkboxes.length;
                
                if (allChecked) {
                    // Desmarcar todos
                    checkboxes.prop('checked', false);
                    $('#toggleSelectAllText').text('Selecionar Todos');
                    $(this).find('i').removeClass('bi-square').addClass('bi-check-square');
                } else {
                    // Selecionar todos
                    checkboxes.prop('checked', true);
                    $('#toggleSelectAllText').text('Desmarcar Todos');
                    $(this).find('i').removeClass('bi-check-square').addClass('bi-square');
                }
            });

            // Atualizar o botão quando checkboxes individuais mudarem
            $('.fechamento-checkbox').change(function() {
                var checkboxes = $('.fechamento-checkbox');
                var allChecked = checkboxes.filter(':checked').length === checkboxes.length;
                
                if (allChecked) {
                    $('#toggleSelectAllText').text('Desmarcar Todos');
                    $('#toggleSelectAll i').removeClass('bi-check-square').addClass('bi-square');
                } else {
                    $('#toggleSelectAllText').text('Selecionar Todos');
                    $('#toggleSelectAll i').removeClass('bi-square').addClass('bi-check-square');
                }
            });

            // Validação antes do submit
            $('form').submit(function(e) {
                var tipoFechamento = $('#tipoFechamento').val();
                var dataInicio = $('#DataInicio').val();
                var dataFim = $('#DataFim').val();

                console.log('Submit - Tipo:', tipoFechamento, 'DataInicio:', dataInicio, 'DataFim:', dataFim);

                if (!dataInicio || !dataFim) {
                    e.preventDefault();
                    alert('Erro: As datas de início e fim não foram preenchidas corretamente. Por favor, tente novamente.');
                    return false;
                }
            });
        });
    </script>
}
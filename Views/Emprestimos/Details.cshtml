@model SistemaTesourariaEclesiastica.Models.Emprestimo

@{
    ViewData["Title"] = $"Empréstimo #{Model.Id.ToString("D3")}";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-lg-10 offset-lg-1">
            <!-- Cabeçalho -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-file-invoice-dollar"></i> Detalhes do Empréstimo #@Model.Id.ToString("D3")</h2>
                <a asp-action="Index" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>

            <!-- Card Principal - Informações do Empréstimo -->
            <div class="card shadow-sm mb-4">
                <div class="card-header @(Model.Status == SistemaTesourariaEclesiastica.Models.StatusEmprestimo.Quitado ? "bg-success" : "bg-warning") text-white">
                    <h4 class="mb-0">
                        @switch (Model.Status)
                        {
                            case SistemaTesourariaEclesiastica.Models.StatusEmprestimo.Ativo:
                                <i class="fas fa-exclamation-circle"></i>
                                <text> Status: Ativo</text>
                                break;
                            case SistemaTesourariaEclesiastica.Models.StatusEmprestimo.Quitado:
                                <i class="fas fa-check-circle"></i>
                                <text> Status: Quitado</text>
                                break;
                            case SistemaTesourariaEclesiastica.Models.StatusEmprestimo.Cancelado:
                                <i class="fas fa-ban"></i>
                                <text> Status: Cancelado</text>
                                break;
                        }
                    </h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="text-muted">Data do Empréstimo</label>
                            <h5>@Model.DataEmprestimo.ToString("dd/MM/yyyy")</h5>
                        </div>
                        @if (Model.DataQuitacao.HasValue)
                        {
                            <div class="col-md-6 mb-3">
                                <label class="text-muted">Data de Quitação</label>
                                <h5 class="text-success">@Model.DataQuitacao.Value.ToString("dd/MM/yyyy")</h5>
                            </div>
                        }
                    </div>

                    <div class="mb-3">
                        <label class="text-muted">Justificativa</label>
                        <p class="border p-3 bg-light rounded">@Model.Justificativa</p>
                    </div>

                    <hr>

                    <!-- Resumo Financeiro -->
                    <div class="row text-center">
                        <div class="col-md-4">
                            <div class="p-3 bg-primary bg-opacity-10 rounded">
                                <label class="text-muted d-block">Valor Total</label>
                                <h3 class="text-primary mb-0">R$ @Model.ValorTotal.ToString("N2")</h3>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 bg-success bg-opacity-10 rounded">
                                <label class="text-muted d-block">Valor Devolvido</label>
                                <h3 class="text-success mb-0">R$ @Model.ValorDevolvido.ToString("N2")</h3>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="p-3 @(Model.SaldoDevedor > 0 ? "bg-danger" : "bg-success") bg-opacity-10 rounded">
                                <label class="text-muted d-block">Saldo Devedor</label>
                                <h3 class="@(Model.SaldoDevedor > 0 ? "text-danger" : "text-success") mb-0">
                                    R$ @Model.SaldoDevedor.ToString("N2")
                                </h3>
                            </div>
                        </div>
                    </div>

                    <!-- Barra de Progresso -->
                    <div class="mt-4">
                        <label class="text-muted d-block mb-2">Progresso de Quitação</label>
                        <div class="progress" style="height: 35px;">
                            <div class="progress-bar @(Model.PercentualDevolvido == 100 ? "bg-success" : "bg-info") progress-bar-striped progress-bar-animated"
                                 role="progressbar"
                                 style="width: @Model.PercentualDevolvido%"
                                 aria-valuenow="@Model.PercentualDevolvido"
                                 aria-valuemin="0"
                                 aria-valuemax="100">
                                <strong>@Model.PercentualDevolvido.ToString("N1")%</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Card de Histórico de Devoluções -->
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0"><i class="fas fa-history"></i> Histórico de Devoluções</h5>
                </div>
                <div class="card-body">
                    @if (!Model.Devolucoes.Any())
                    {
                        <div class="alert alert-warning text-center">
                            <i class="fas fa-info-circle"></i> Nenhuma devolução registrada ainda.
                        </div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>#</th>
                                        <th>Data</th>
                                        <th>Valor Devolvido</th>
                                        <th>Observações</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @{
                                        var contador = 1;
                                        foreach (var devolucao in Model.Devolucoes.OrderBy(d => d.DataDevolucao))
                                        {
                                            <tr>
                                                <td><strong>@contador</strong></td>
                                                <td>@devolucao.DataDevolucao.ToString("dd/MM/yyyy")</td>
                                                <td class="text-success"><strong>R$ @devolucao.ValorDevolvido.ToString("N2")</strong></td>
                                                <td>
                                                    @if (string.IsNullOrWhiteSpace(devolucao.Observacoes))
                                                    {
                                                        <em class="text-muted">Sem observações</em>
                                                    }
                                                    else
                                                    {
                                                        @devolucao.Observacoes
                                                    }
                                                </td>
                                            </tr>
                                            contador++;
                                        }
                                    }
                                </tbody>
                                <tfoot class="table-light">
                                    <tr>
                                        <td colspan="2" class="text-end"><strong>Total Devolvido:</strong></td>
                                        <td class="text-success"><strong>R$ @Model.ValorDevolvido.ToString("N2")</strong></td>
                                        <td></td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    }
                </div>
            </div>

            <!-- Ações Adicionais -->
            @if (Model.Status == SistemaTesourariaEclesiastica.Models.StatusEmprestimo.Ativo)
            {
                <div class="mt-4 text-center">
                    <button type="button"
                            class="btn btn-primary btn-lg"
                            data-bs-toggle="modal"
                            data-bs-target="#modalDevolucaoDetails">
                        <i class="fas fa-coins"></i> Registrar Nova Devolução
                    </button>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal de Devolução (Details) -->
<div class="modal fade" id="modalDevolucaoDetails" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-coins"></i> Registrar Devolução</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form id="formDevolucaoDetails">
                <div class="modal-body">
                    <input type="hidden" id="emprestimoIdDetails" name="emprestimoId" value="@Model.Id">

                    <div class="alert alert-info">
                        <strong>Saldo Devedor:</strong> R$ <span id="saldoDevedorDetails">@Model.SaldoDevedor.ToString("N2")</span>
                    </div>

                    <div class="mb-3">
                        <label for="valorDevolvido" class="form-label">Valor a Devolver *</label>
                        <div class="input-group">
                            <span class="input-group-text">R$</span>
                            <input type="number" step="0.01" class="form-control" id="valorDevolvidoDetails"
                                   name="valorDevolvido" required min="0.01" max="@Model.SaldoDevedor">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="dataDevolucao" class="form-label">Data da Devolução *</label>
                        <input type="date" class="form-control" id="dataDevolucaoDetails"
                               name="dataDevolucao" required>
                    </div>

                    <div class="mb-3">
                        <label for="observacoes" class="form-label">Observações</label>
                        <textarea class="form-control" id="observacoesDetails" name="observacoes"
                                  rows="3" maxlength="300"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Registrar Devolução
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Configurar data atual como padrão
            $('#dataDevolucaoDetails').val(new Date().toISOString().split('T')[0]);

            // Submit do formulário de devolução
            $('#formDevolucaoDetails').submit(function(e) {
                e.preventDefault();

                var emprestimoId = $('#emprestimoIdDetails').val();
                var valorDevolvido = parseFloat($('#valorDevolvidoDetails').val());
                var dataDevolucao = $('#dataDevolucaoDetails').val();
                var observacoes = $('#observacoesDetails').val();

                $.ajax({
                    url: '@Url.Action("RegistrarDevolucao", "Emprestimos")',
                    type: 'POST',
                    data: {
                        __RequestVerificationToken: $('input[name="__RequestVerificationToken"]').val(),
                        emprestimoId: emprestimoId,
                        valorDevolvido: valorDevolvido,
                        dataDevolucao: dataDevolucao,
                        observacoes: observacoes
                    },
                    success: function(response) {
                        if (response.sucesso) {
                            $('#modalDevolucaoDetails').modal('hide');

                            Swal.fire({
                                icon: 'success',
                                title: 'Sucesso!',
                                text: response.mensagem,
                                confirmButtonText: 'OK'
                            }).then(() => {
                                location.reload();
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Erro',
                                text: response.mensagem
                            });
                        }
                    },
                    error: function() {
                        Swal.fire({
                            icon: 'error',
                            title: 'Erro',
                            text: 'Ocorreu um erro ao processar a devolução.'
                        });
                    }
                });
            });
        });
    </script>
}
@model SistemaTesourariaEclesiastica.ViewModels.EscalaManualViewModel
@{
    ViewData["Title"] = "Escala Manual de Porteiros";
}

<div class="container-fluid py-4">
    <!-- Cabeçalho -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">
                <i class="bi bi-hand-index-thumb me-2"></i>Escala Manual de Porteiros
            </h2>
            <p class="text-muted mb-0">Arraste e solte os porteiros nos dias desejados</p>
        </div>
        <div>
            <a asp-action="Index" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left me-1"></i>Voltar
            </a>
        </div>
    </div>

    <!-- Filtros e Controles -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form id="formFiltros" asp-action="ManualEscala" method="get">
                <div class="row g-3 align-items-end">
                    <div class="col-md-3">
                        <label for="dataInicio" class="form-label fw-semibold">Data Início</label>
                        <input type="date" class="form-control" id="dataInicio" name="dataInicio" 
                               value="@Model.DataInicio.ToString("yyyy-MM-dd")" required />
                    </div>
                    <div class="col-md-3">
                        <label for="dataFim" class="form-label fw-semibold">Data Fim</label>
                        <input type="date" class="form-control" id="dataFim" name="dataFim" 
                               value="@Model.DataFim.ToString("yyyy-MM-dd")" required />
                    </div>
                    <div class="col-md-4">
                        <label for="responsavelId" class="form-label fw-semibold">Responsável</label>
                        <select class="form-select" id="responsavelId" name="responsavelId" required>
                            @foreach (var responsavel in Model.ResponsaveisDisponiveis)
                            {
                                <option value="@responsavel.Id" selected="@(responsavel.Id == Model.ResponsavelSelecionadoId)">
                                    @responsavel.Nome
                                </option>
                            }
                        </select>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-search me-1"></i>Filtrar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Área de Trabalho com Drag and Drop -->
    <div class="row">
        <!-- Coluna Esquerda: Porteiros Disponíveis -->
        <div class="col-lg-3">
            <div class="card shadow-sm sticky-top" style="top: 20px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-people me-2"></i>Porteiros Disponíveis
                    </h5>
                    <small class="d-block mt-1">Arraste para os dias ?</small>
                </div>
                <div class="card-body p-3" id="porteirosDisponiveis" style="max-height: 70vh; overflow-y: auto;">
                    @foreach (var porteiro in Model.PorteirosDisponiveis)
                    {
                        <div class="porteiro-item mb-2" 
                             draggable="true" 
                             data-porteiro-id="@porteiro.Id"
                             data-porteiro-nome="@porteiro.Nome">
                            <div class="d-flex align-items-center p-2 bg-light border rounded cursor-move">
                                <div class="porteiro-avatar me-2">
                                    <i class="bi bi-person-circle text-primary fs-4"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <div class="fw-semibold">@porteiro.Nome</div>
                                    @if (!string.IsNullOrEmpty(porteiro.Telefone))
                                    {
                                        <small class="text-muted d-block">
                                            <i class="bi bi-telephone me-1"></i>@porteiro.Telefone
                                        </small>
                                    }
                                </div>
                                <i class="bi bi-grip-vertical text-muted"></i>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Coluna Direita: Dias Disponíveis -->
        <div class="col-lg-9">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-week me-2"></i>Dias do Período
                        </h5>
                        <small class="d-block mt-1">@Model.DiasDisponiveis.Count dia(s) de culto</small>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-warning btn-sm" id="btnLimparEscala" title="Remove todos os porteiros atribuídos">
                            <i class="bi bi-eraser me-1"></i>Limpar Escala
                        </button>
                        <button type="button" class="btn btn-light btn-sm" id="btnSalvarEscala">
                            <i class="bi bi-save me-1"></i>Salvar Escala
                        </button>
                    </div>
                </div>
                <div class="card-body p-3" style="max-height: 75vh; overflow-y: auto;">
                    @if (!Model.DiasDisponiveis.Any())
                    {
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Nenhum dia disponível no período selecionado. Ajuste as datas ou configure os cultos em 
                            <a asp-controller="ConfiguracoesCultos" asp-action="Index">Configurações de Cultos</a>.
                        </div>
                    }
                    else
                    {
                        <div class="row g-3" id="diasDisponiveis">
                            @foreach (var dia in Model.DiasDisponiveis.OrderBy(d => d.Data).ThenBy(d => d.Horario))
                            {
                                <div class="col-md-6 col-xl-4">
                                    <div class="dia-card card h-100 border-2" 
                                         data-dia-date="@dia.Data.ToString("yyyy-MM-dd")" 
                                         data-dia-horario="@dia.HorarioFormatado"
                                         data-dia-tipo="@((int)dia.TipoCulto)"
                                         data-qtd-necessaria="@dia.QuantidadePorteirosNecessaria">
                                        
                                        <!-- Cabeçalho do Dia -->
                                        <div class="card-header bg-light border-bottom-2">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <div class="fw-bold text-primary">@dia.DiaSemana</div>
                                                    <small class="text-muted">@dia.DataFormatada</small>
                                                </div>
                                                <span class="badge bg-primary">@dia.TipoCulto.ToString().Replace("Evangelistico", "Evangelístico")</span>
                                            </div>
                                            @if (!string.IsNullOrEmpty(dia.HorarioFormatado))
                                            {
                                                <div class="mt-2">
                                                    <i class="bi bi-clock text-muted me-1"></i>
                                                    <span class="fw-semibold">@dia.HorarioFormatado</span>
                                                </div>
                                            }
                                        </div>

                                        <!-- Área de Drop para Porteiros -->
                                        <div class="card-body porteiros-drop-zone" style="min-height: 120px;">
                                            
                                            <div class="text-center text-muted mb-2">
                                                <small>
                                                    <i class="bi bi-hand-index me-1"></i>
                                                    Arraste @dia.QuantidadePorteirosNecessaria porteiro(s) aqui
                                                </small>
                                            </div>

                                            <!-- Porteiros já atribuídos (se houver) -->
                                            @if (dia.PorteirosAtribuidos.Any())
                                            {
                                                foreach (var porteiroAtribuido in dia.PorteirosAtribuidos.OrderBy(p => p.Posicao))
                                                {
                                                    <div class="porteiro-atribuido mb-2 p-2 rounded position-relative" 
                                                         data-porteiro-id="@porteiroAtribuido.PorteiroId"
                                                         data-porteiro-nome="@porteiroAtribuido.NomePorteiro"
                                                         data-posicao="@porteiroAtribuido.Posicao">
                                                        <div class="d-flex align-items-center">
                                                            <span class="badge bg-success me-2">@porteiroAtribuido.Posicao</span>
                                                            <div class="flex-grow-1">
                                                                <div class="fw-semibold text-success">@porteiroAtribuido.NomePorteiro</div>
                                                            </div>
                                                            <button type="button" class="btn btn-sm btn-danger btn-remover-porteiro" 
                                                                    title="Remover porteiro">
                                                                <i class="bi bi-x-lg"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                }
                                            }
                                        </div>

                                        <!-- Contador de Porteiros -->
                                        <div class="card-footer bg-white border-top">
                                            <small class="text-muted">
                                                <i class="bi bi-person-check me-1"></i>
                                                <span class="contador-porteiros">@dia.PorteirosAtribuidos.Count</span> de 
                                                <span class="total-necessario">@dia.QuantidadePorteirosNecessaria</span> porteiro(s)
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Legenda -->
    <div class="card mt-4 shadow-sm">
        <div class="card-body">
            <h6 class="mb-3"><i class="bi bi-info-circle me-2"></i>Instruções</h6>
            <div class="row g-3">
                <div class="col-md-4">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-1-circle-fill text-primary me-2 fs-5"></i>
                        <div>
                            <strong>Arrastar Porteiro</strong>
                            <p class="mb-0 small text-muted">Clique e arraste um porteiro da lista para o dia desejado</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-2-circle-fill text-success me-2 fs-5"></i>
                        <div>
                            <strong>Duplas Automáticas</strong>
                            <p class="mb-0 small text-muted">Cultos noturnos (?19h) requerem 2 porteiros automaticamente</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="d-flex align-items-start">
                        <i class="bi bi-3-circle-fill text-warning me-2 fs-5"></i>
                        <div>
                            <strong>Salvar Escala</strong>
                            <p class="mb-0 small text-muted">Após atribuir todos os porteiros, clique em "Salvar Escala"</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/escala-manual.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/js/escala-manual.js" asp-append-version="true"></script>
    <script>
        // Configurações iniciais
        const responsavelId = @Model.ResponsavelSelecionadoId;
        const dataInicio = '@Model.DataInicio.ToString("yyyy-MM-dd")';
        const dataFim = '@Model.DataFim.ToString("yyyy-MM-dd")';
    </script>
}

@model IEnumerable<SistemaTesourariaEclesiastica.Models.Saida>

@{
    ViewData["Title"] = "Despesas por Centro de Custo";
}

<!-- Cabe√ßalho -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-2">
    <div>
        <h1 class="h3 mb-1">
    <i class="bi bi-diagram-3 me-2 text-secondary"></i>Despesas por Centro de Custo
  </h1>
        <p class="text-muted mb-0 small">An√°lise de gastos por unidade administrativa</p>
    </div>
    <div class="d-flex gap-2">
        <a asp-action="ExportarSaidasExcel" asp-route-dataInicio="@ViewBag.DataInicio" asp-route-dataFim="@ViewBag.DataFim" class="btn btn-success btn-sm">
            <i class="bi bi-file-excel me-1"></i>Excel
        </a>
        <a asp-action="ExportarSaidasPdf" asp-route-dataInicio="@ViewBag.DataInicio" asp-route-dataFim="@ViewBag.DataFim" class="btn btn-danger btn-sm">
            <i class="bi bi-file-pdf me-1"></i>PDF
        </a>
  <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
   <i class="bi bi-arrow-left me-1"></i>Voltar
        </a>
    </div>
</div>

<!-- Filtros -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
   <form method="get" class="row g-3">
     <div class="col-12 col-md-3">
          <label class="form-label small fw-semibold">Data In√≠cio</label>
                <input type="date" class="form-control" name="dataInicio" value="@ViewBag.DataInicio" />
            </div>
            <div class="col-12 col-md-3">
      <label class="form-label small fw-semibold">Data Fim</label>
    <input type="date" class="form-control" name="dataFim" value="@ViewBag.DataFim" />
            </div>
            <div class="col-12 col-md-3">
        <label class="form-label small fw-semibold">Centro de Custo</label>
 <select class="form-select" name="centroCustoId" asp-items="ViewBag.CentrosCusto">
    <option value="">Todos</option>
     </select>
      </div>
         @if (ViewBag.PlanosContas != null)
            {
       <div class="col-12 col-md-2">
        <label class="form-label small fw-semibold">Categoria</label>
      <select class="form-select" name="planoContasId" asp-items="ViewBag.PlanosContas">
            <option value="">Todas</option>
   </select>
              </div>
            }
            <div class="col-12 col-md-1 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
        <i class="bi bi-search"></i>
       </button>
     </div>
        </form>
    </div>
</div>

<!-- Resumo por Centro de Custo -->
@if (ViewBag.ResumoPorCentroCusto != null && ((IEnumerable<dynamic>)ViewBag.ResumoPorCentroCusto).Any())
{
    <div class="row g-3 mb-4">
    @foreach (var resumo in ViewBag.ResumoPorCentroCusto)
        {
            <div class="col-12 col-sm-6 col-md-4 col-lg-3">
      <div class="card shadow-sm border-0 border-start border-danger border-4 h-100">
              <div class="card-body">
      <div class="d-flex align-items-center mb-2">
   <div class="flex-shrink-0 me-2">
     <div class="avatar-circle bg-secondary text-white" style="width: 40px; height: 40px;">
     <i class="bi bi-building"></i>
      </div>
       </div>
  <div class="flex-grow-1">
  <h6 class="mb-0 fw-semibold small">@resumo.CentroCustoNome</h6>
      </div>
         </div>
    <div class="text-center mt-3">
     <h4 class="mb-1 fw-bold text-danger">@resumo.TotalDespesas.ToString("C2")</h4>
      <small class="text-muted">@resumo.QuantidadeDespesas despesa(s)</small>
          </div>
      </div>
        </div>
            </div>
        }
    </div>
}

@* ‚úÖ CORRIGIDO: Resumo por Categoria dentro de cada Centro de Custo *@
@if (ViewBag.ResumoPorCategoria != null && ((IEnumerable<dynamic>)ViewBag.ResumoPorCategoria).Any())
{
    <div class="card shadow-sm mb-4 border-warning">
        <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center py-3">
    <h5 class="mb-0 fw-semibold">
       <i class="bi bi-pie-chart me-2"></i>
       üìä Despesas por Categoria e Centro de Custo
   </h5>
        </div>
    <div class="card-body p-0">
   <div class="table-responsive">
           <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
 <tr>
    <th class="ps-3">Centro de Custo</th>
     <th>Categoria</th>
        <th class="text-end">Total</th>
   <th class="text-center">Quantidade</th>
       </tr>
        </thead>
     <tbody>
 @{
                   var categoriasList = ((IEnumerable<dynamic>)ViewBag.ResumoPorCategoria).ToList();
       string? currentCentroCusto = null;
decimal subtotal = 0;
             int currentIndex = 0;
        }
    @foreach (var item in categoriasList)
               {
                 // Se mudou de centro de custo e n√£o √© o primeiro, mostra subtotal
     if (currentCentroCusto != null && currentCentroCusto != item.CentroCustoNome)
    {
      <tr class="table-secondary">
        <td colspan="2" class="ps-3"><strong>Subtotal @currentCentroCusto</strong></td>
   <td class="text-end"><strong>@subtotal.ToString("C2")</strong></td>
       <td></td>
       </tr>
                subtotal = 0;
    }
          
           // Verifica se √© primeira ocorr√™ncia deste centro de custo
  bool isPrimeiraCelulaDoCentro = (currentIndex == 0) || 
          (categoriasList[currentIndex - 1].CentroCustoNome != item.CentroCustoNome);
              
          currentCentroCusto = item.CentroCustoNome;
 subtotal += item.TotalDespesas;

  <tr>
    <td class="ps-3">
            @if (isPrimeiraCelulaDoCentro)
  {
  <div class="d-flex align-items-center">
      <i class="bi bi-building-fill text-secondary me-2"></i>
<strong>@item.CentroCustoNome</strong>
</div>
        }
       </td>
  <td>
             <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">
                   @item.CategoriaNome
   </span>
           </td>
     <td class="text-end">
           <span class="fw-bold text-danger">@item.TotalDespesas.ToString("C2")</span>
    </td>
  <td class="text-center">
    <span class="badge bg-primary">@item.QuantidadeDespesas</span>
         </td>
      </tr>
  
          currentIndex++;
    }
        
        @* √öltimo subtotal *@
      @if (currentCentroCusto != null)
          {
             <tr class="table-secondary">
          <td colspan="2" class="ps-3"><strong>Subtotal @currentCentroCusto</strong></td>
      <td class="text-end"><strong>@subtotal.ToString("C2")</strong></td>
         <td></td>
        </tr>
            }
  </tbody>
                 <tfoot class="table-warning">
   <tr>
   <th class="ps-3" colspan="2">TOTAL GERAL</th>
      <th class="text-end">
     <span class="fw-bold text-dark fs-5">
  @(categoriasList.Sum(x => (decimal)x.TotalDespesas).ToString("C2"))
        </span>
          </th>
               <th class="text-center">
      @categoriasList.Sum(x => (int)x.QuantidadeDespesas)
     </th>
 </tr>
 </tfoot>
    </table>
            </div>
        </div>
    </div>
}

<!-- Detalhamento das Despesas -->
@if (Model != null && Model.Any())
{
 <div class="card shadow-sm">
 <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
          <h5 class="mb-0 fw-semibold">
       <i class="bi bi-list-ul me-2 text-danger"></i>
      Detalhamento das Despesas
         </h5>
   <button type="button" class="btn btn-sm btn-outline-secondary" onclick="window.print()">
    <i class="bi bi-printer me-1"></i>Imprimir
         </button>
 </div>
      <div class="card-body p-0">
   <div class="table-responsive">
     <table class="table table-hover align-middle mb-0" id="despesasTable">
          <thead class="table-light">
               <tr>
         <th class="ps-3">Data</th>
      <th>Descri√ß√£o</th>
        <th class="d-none d-md-table-cell">Fornecedor</th>
     <th class="d-none d-lg-table-cell">Centro de Custo</th>
    <th class="d-none d-xl-table-cell">Categoria</th>
         <th class="d-none d-xl-table-cell">Meio Pgto</th>
<th class="text-end">Valor</th>
      </tr>
    </thead>
            <tbody>
       @foreach (var item in Model)
     {
    <tr>
    <td class="ps-3">
                <div class="fw-semibold">@item.Data.ToString("dd/MM/yy")</div>
             <small class="text-muted">@item.Data.ToString("HH:mm")</small>
              </td>
        <td>
                <div class="fw-semibold">@item.Descricao</div>
     <small class="text-muted d-md-none">
    @if (item.Fornecedor != null)
  {
          @item.Fornecedor.Nome
         }
   </small>
       </td>
      <td class="d-none d-md-table-cell">
  @if (item.Fornecedor != null)
             {
      <span>@item.Fornecedor.Nome</span>
         }
          else
             {
                 <span class="text-muted fst-italic">-</span>
            }
             </td>
         <td class="d-none d-lg-table-cell">
         <span class="badge bg-info bg-opacity-10 text-info border border-info">
                 @item.CentroCusto?.Nome
         </span>
    </td>
   <td class="d-none d-xl-table-cell">
  <span class="badge bg-danger bg-opacity-10 text-danger border border-danger">
  @item.PlanoDeContas?.Nome
    </span>
                 </td>
              <td class="d-none d-xl-table-cell">
             <small class="text-muted">@item.MeioDePagamento?.Nome</small>
   </td>
      <td class="text-end">
      <span class="fw-bold text-danger">@item.Valor.ToString("C2")</span>
     </td>
                </tr>
             }
     </tbody>
    <tfoot class="table-light">
  <tr>
 <th class="ps-3" colspan="6">TOTAL GERAL</th>
      <th class="text-end">
        <span class="fw-bold text-danger">@Model.Sum(x => x.Valor).ToString("C2")</span>
               </th>
             </tr>
          </tfoot>
          </table>
            </div>
        </div>
    </div>
}
else
{
    <div class="card shadow-sm">
        <div class="card-body text-center py-5">
        <i class="bi bi-inbox text-muted" style="font-size: 4rem;"></i>
            <h5 class="mt-3 text-muted">Nenhuma despesa encontrada</h5>
            <p class="text-muted">N√£o h√° despesas para o per√≠odo e filtros selecionados.</p>
        </div>
    </div>
}